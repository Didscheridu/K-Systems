<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K-Systems Schul-Login</title>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            background-color: #f0f2f5; 
            margin: 0; padding: 0;
            display: flex; justify-content: center; align-items: center; min-height: 100vh;
        }

        /* Container f√ºr Login und App */
        .container { width: 90%; max-width: 400px; padding: 20px; }

        /* Login Box Styles */
        .auth-box {
            background: white; padding: 30px; border-radius: 12px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.1); text-align: center;
        }
        .auth-box h2 { margin-top: 0; color: #333; }
        .hidden { display: none !important; }

        input {
            width: 100%; padding: 12px; margin: 8px 0;
            border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 16px;
        }

        button {
            width: 100%; padding: 12px; margin-top: 10px;
            background: #007bff; color: white; border: none; border-radius: 6px;
            font-size: 16px; font-weight: bold; cursor: pointer; transition: 0.2s;
        }
        button:hover { background: #0056b3; }
        
        .switch-btn {
            background: none; color: #007bff; margin-top: 10px; font-weight: normal; font-size: 14px;
        }
        .switch-btn:hover { background: none; text-decoration: underline; color: #0056b3; }

        /* Chat Styles (App) */
        .app-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .logout-btn { background: #dc3545; width: auto; padding: 5px 15px; font-size: 14px; }
        
        .post { background: white; padding: 15px; border-radius: 10px; margin-bottom: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .post small { color: #888; font-size: 12px; }
        .post h4 { margin: 0 0 5px 0; color: #007bff; }
    </style>
</head>
<body>

<div class="container">

    <div id="authContainer" class="auth-box">
        <h2 id="authTitle">Anmelden</h2>
        <input type="email" id="emailInput" placeholder="E-Mail Adresse">
        <input type="password" id="passwordInput" placeholder="Passwort">
        
        <button id="authBtn">Einloggen</button>
        <button id="toggleBtn" class="switch-btn">Kein Konto? Registrieren</button>
        <p id="errorMsg" style="color: red; font-size: 14px; display: none;"></p>
    </div>

    <div id="appContainer" class="hidden">
        <div class="app-header">
            <h3>üè´ K-Systems Feed</h3>
            <button id="logoutBtn" class="logout-btn">Abmelden</button>
        </div>

        <div style="background: white; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
            <textarea id="msgInput" style="width:100%; height:60px; border:1px solid #ddd; padding:10px; border-radius:6px;" placeholder="Nachricht schreiben..."></textarea>
            <button id="sendBtn">Senden üöÄ</button>
        </div>

        <div id="feed">Lade Nachrichten...</div>
    </div>

</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    // Deine Config
    const firebaseConfig = {
        apiKey: "AIzaSyC1lOo3wm36dSi1Ec574tGaoySlg_783gI",
        authDomain: "k-systems-7f298.firebaseapp.com",
        projectId: "k-systems-7f298",
        storageBucket: "k-systems-7f298.firebasestorage.app",
        messagingSenderId: "768481373703",
        appId: "1:768481373703:web:64f3e07ceba8a6b0c7c4a2",
        measurementId: "G-R3JNW22EZ8"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // Elemente holen
    const authContainer = document.getElementById('authContainer');
    const appContainer = document.getElementById('appContainer');
    const authTitle = document.getElementById('authTitle');
    const authBtn = document.getElementById('authBtn');
    const toggleBtn = document.getElementById('toggleBtn');
    const emailInput = document.getElementById('emailInput');
    const passwordInput = document.getElementById('passwordInput');
    const errorMsg = document.getElementById('errorMsg');

    let isLoginMode = true; // Merken, ob wir gerade Login oder Registrieren machen

    // Pr√ºfen, ob User eingeloggt ist
    onAuthStateChanged(auth, (user) => {
        if (user) {
            // User ist da -> Login weg, Chat zeigen
            authContainer.classList.add('hidden');
            appContainer.classList.remove('hidden');
            document.body.style.alignItems = "flex-start"; // Layout anpassen
            loadChat(); // Chat starten
        } else {
            // Niemand da -> Login zeigen, Chat weg
            authContainer.classList.remove('hidden');
            appContainer.classList.add('hidden');
            document.body.style.alignItems = "center";
        }
    });

    // Umschalten zwischen Login und Registrieren
    toggleBtn.addEventListener('click', () => {
        isLoginMode = !isLoginMode;
        if (isLoginMode) {
            authTitle.innerText = "Anmelden";
            authBtn.innerText = "Einloggen";
            toggleBtn.innerText = "Kein Konto? Registrieren";
        } else {
            authTitle.innerText = "Konto erstellen";
            authBtn.innerText = "Registrieren";
            toggleBtn.innerText = "Zur√ºck zum Login";
        }
        errorMsg.style.display = 'none';
    });

    // Login oder Registrieren Button Klick
    authBtn.addEventListener('click', async () => {
        const email = emailInput.value;
        const password = passwordInput.value;

        try {
            if (isLoginMode) {
                await signInWithEmailAndPassword(auth, email, password);
            } else {
                await createUserWithEmailAndPassword(auth, email, password);
            }
        } catch (error) {
            errorMsg.innerText = error.message;
            errorMsg.style.display = 'block';
        }
    });

    // Logout
    document.getElementById('logoutBtn').addEventListener('click', () => {
        signOut(auth);
    });

    // --- CHAT LOGIK (fast gleich wie vorher) ---
    function loadChat() {
        const q = query(collection(db, "schul_chat"), orderBy("timestamp", "desc"));
        onSnapshot(q, (snapshot) => {
            const feed = document.getElementById('feed');
            feed.innerHTML = "";
            snapshot.forEach((doc) => {
                const data = doc.data();
                const userEmail = data.user || "Unbekannt";
                // Nur den Teil vor dem @ anzeigen als Name
                const shortName = userEmail.split('@')[0]; 
                
                feed.innerHTML += `
                    <div class="post">
                        <h4>${shortName}</h4>
                        <p>${data.text}</p>
                        <small>${data.timestamp ? new Date(data.timestamp.toDate()).toLocaleTimeString() : '...'}</small>
                    </div>`;
            });
        });

        // Senden Button
        document.getElementById('sendBtn').onclick = async () => {
            const msg = document.getElementById('msgInput').value;
            if (msg.trim() === "") return;
            
            await addDoc(collection(db, "schul_chat"), {
                user: auth.currentUser.email, // Wir speichern jetzt die echte E-Mail!
                text: msg,
                timestamp: serverTimestamp()
            });
            document.getElementById('msgInput').value = "";
        };
    }
</script>

</body>
</html>
