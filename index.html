<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Schul-Portal (Lite)</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f0f2f5; margin: 0; padding-bottom: 50px; }
        .container { max-width: 600px; margin: 0 auto; padding: 10px; }
        .card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); width: 100%; box-sizing: border-box; margin-bottom: 20px; }
        input, button, textarea { width: 100%; padding: 12px; margin: 5px 0; border-radius: 5px; border: 1px solid #ddd; box-sizing: border-box; }
        button { background: #007bff; color: white; border: none; font-weight: bold; cursor: pointer; }
        button:hover { background: #0056b3; }
        .nav-tabs { display: flex; justify-content: space-around; background: white; padding: 10px; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .nav-btn { background: none; color: #555; border: none; font-size: 16px; border-bottom: 3px solid transparent; }
        .nav-btn.active { color: #007bff; border-bottom: 3px solid #007bff; }
        .post img { max-width: 100%; border-radius: 5px; margin-top: 10px; }
        .hidden { display: none !important; }
        .teacher-badge { background: #dc3545; color: white; padding: 2px 6px; border-radius: 4px; font-size: 12px; }
    </style>
</head>
<body>

<div id="authContainer" class="container" style="height: 100vh; display: flex; align-items: center;">
    <div class="card">
        <h2 id="authTitle">Anmelden</h2>
        <input type="email" id="emailInput" placeholder="E-Mail">
        <input type="password" id="passwordInput" placeholder="Passwort">
        <button id="mainAuthBtn">Einloggen</button>
        <button id="toggleAuthMode" style="background:grey">Kein Konto? Registrieren</button>
        <p id="errorMsg" style="color:red; display:none;"></p>
    </div>
</div>

<div id="appContainer" class="hidden">
    <div class="nav-tabs">
        <button class="nav-btn active" onclick="switchTab('chat')">ðŸ’¬ Pausenhof</button>
        <button class="nav-btn" onclick="switchTab('tasks')">ðŸ“š AuftrÃ¤ge</button>
        <button onclick="logout()" style="width:auto; background:#dc3545; padding:5px 10px;">X</button>
    </div>

    <div class="container" style="margin-top: 20px;">
        <div id="inputSection" class="card">
            <h3>Neuer Beitrag</h3>
            <input type="text" id="postTitle" placeholder="Titel (Optional)">
            <textarea id="postText" rows="3" placeholder="Nachricht..."></textarea>
            
            <label style="font-size:12px; color:#666;">Bild hinzufÃ¼gen (Max 1 MB!):</label>
            <input type="file" id="imageInput" accept="image/*">
            
            <button id="sendBtn">Absenden ðŸš€</button>
        </div>

        <div id="feedList">Lade...</div>
    </div>
</div>

<script type="module">
    // Wir importieren NUR Auth und Firestore (Kein Storage!)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyC1lOo3wm36dSi1Ec574tGaoySlg_783gI",
        authDomain: "k-systems-7f298.firebaseapp.com",
        projectId: "k-systems-7f298",
        storageBucket: "k-systems-7f298.firebasestorage.app",
        messagingSenderId: "768481373703",
        appId: "1:768481373703:web:64f3e07ceba8a6b0c7c4a2"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    let currentUser = null;
    let currentTab = 'chat';
    const ADMIN_EMAIL = "kayden.schunack@gmail.com";

    // --- AUTH ---
    const authContainer = document.getElementById('authContainer');
    const appContainer = document.getElementById('appContainer');
    let isRegistering = false;

    onAuthStateChanged(auth, (user) => {
        if (user) {
            currentUser = user;
            authContainer.classList.add('hidden');
            appContainer.classList.remove('hidden');
            loadFeed();
            updateInputVisibility();
        } else {
            currentUser = null;
            authContainer.classList.remove('hidden');
            appContainer.classList.add('hidden');
        }
    });

    document.getElementById('mainAuthBtn').onclick = async () => {
        try {
            const email = document.getElementById('emailInput').value;
            const pw = document.getElementById('passwordInput').value;
            if(isRegistering) await createUserWithEmailAndPassword(auth, email, pw);
            else await signInWithEmailAndPassword(auth, email, pw);
        } catch(e) { alert(e.message); }
    };

    document.getElementById('toggleAuthMode').onclick = () => {
        isRegistering = !isRegistering;
        document.getElementById('authTitle').innerText = isRegistering ? "Registrieren" : "Anmelden";
        document.getElementById('mainAuthBtn').innerText = isRegistering ? "Registrieren" : "Einloggen";
    };

    window.logout = () => signOut(auth);

    // --- TABS ---
    window.switchTab = (tab) => {
        currentTab = tab;
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');
        loadFeed();
        updateInputVisibility();
    };

    function updateInputVisibility() {
        const section = document.getElementById('inputSection');
        if (currentTab === 'chat') {
            section.classList.remove('hidden');
        } else {
            // Nur Kayden sieht Eingabe bei AuftrÃ¤gen
            if (currentUser && currentUser.email.toLowerCase() === ADMIN_EMAIL.toLowerCase()) {
                section.classList.remove('hidden');
            } else {
                section.classList.add('hidden');
            }
        }
    }

    // --- HACK: BILD ZU TEXT KONVERTIEREN ---
    const convertBase64 = (file) => {
        return new Promise((resolve, reject) => {
            const fileReader = new FileReader();
            fileReader.readAsDataURL(file);
            fileReader.onload = () => resolve(fileReader.result);
            fileReader.onerror = (error) => reject(error);
        });
    };

    document.getElementById('sendBtn').onclick = async () => {
        const title = document.getElementById('postTitle').value;
        const text = document.getElementById('postText').value;
        const fileInput = document.getElementById('imageInput');
        
        if (!text && !fileInput.files.length) return;

        document.getElementById('sendBtn').innerText = "Sende...";

        try {
            let imageBase64 = null;
            
            // Wenn ein Bild gewÃ¤hlt wurde, wandle es in Text um
            if (fileInput.files.length > 0) {
                const file = fileInput.files[0];
                if (file.size > 1000000) { // 1MB Limit prÃ¼fen
                    alert("Bild ist zu groÃŸ! Bitte unter 1MB bleiben.");
                    document.getElementById('sendBtn').innerText = "Senden ðŸš€";
                    return;
                }
                imageBase64 = await convertBase64(file);
            }

            const coll = currentTab === 'chat' ? 'chat_public' : 'school_tasks';
            
            await addDoc(collection(db, coll), {
                user: currentUser.email,
                title: title,
                text: text,
                image: imageBase64, // Hier speichern wir den Bild-Code direkt!
                timestamp: serverTimestamp()
            });

            document.getElementById('postText').value = "";
            document.getElementById('postTitle').value = "";
            fileInput.value = "";
            document.getElementById('sendBtn').innerText = "Senden ðŸš€";

        } catch (e) {
            console.error(e);
            alert("Fehler: " + e.message);
            document.getElementById('sendBtn').innerText = "Fehler";
        }
    };

    // --- FEED ---
    let unsubscribe;
    function loadFeed() {
        if(unsubscribe) unsubscribe();
        const coll = currentTab === 'chat' ? 'chat_public' : 'school_tasks';
        const list = document.getElementById('feedList');
        
        const q = query(collection(db, coll), orderBy("timestamp", "desc"));
        
        unsubscribe = onSnapshot(q, (snapshot) => {
            list.innerHTML = "";
            if (snapshot.empty) list.innerHTML = "<p style='text-align:center'>Nichts da.</p>";

            snapshot.forEach(doc => {
                const data = doc.data();
                const isTeacher = data.user.toLowerCase() === ADMIN_EMAIL.toLowerCase();
                const name = data.user.split('@')[0];
                
                list.innerHTML += `
                    <div class="card" style="${isTeacher && currentTab === 'tasks' ? 'border-left:5px solid red' : ''}">
                        <div style="display:flex; justify-content:space-between">
                            <strong>${name} ${isTeacher ? '<span class="teacher-badge">Lehrer</span>' : ''}</strong>
                        </div>
                        ${data.title ? `<b>${data.title}</b><br>` : ''}
                        <p>${data.text}</p>
                        ${data.image ? `<img src="${data.image}">` : ''}
                    </div>
                `;
            });
        });
    }
</script>

</body>
</html>
